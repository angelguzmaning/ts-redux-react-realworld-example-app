version: 2.1

workflows:
  ci-cd:  
    jobs:
      - build-docker-image:
          context: moonwalkers
      - deploy-helm-chart:
          context: moonwalkers
          #requires: 
          #  - build-docker-image

commands:
  prepare-gcp:
    steps:
      - gcp-cli/install:
          version: 366.0.0
      - gcp-cli/initialize:
          gcloud-service-key: GCLOUD_SERVICE_KEY
          google-compute-region: GCLOUD_COMPUTE_REGION
          google-compute-zone: GCLOUD_COMPUTE_ZONE
          google-project-id: GCLOUD_PROJECT_ID
  configure-artifact-registry:
    steps:
      - run:
          name: Configure Artifact Registry
          command: |
            gcloud auth configure-docker us-east1-docker.pkg.dev
  connect-to-gke-cluster:
    steps:
      - run:
          name: Connect to GKE cluster
          command: |
            gcloud container clusters get-credentials gke-ycit021-devops-project --region us-east1

jobs:
  build-docker-image:
    docker: 
      - image: cimg/base:2021.11
    steps:
      - checkout
      - setup_remote_docker
      - prepare-gcp
      - configure-artifact-registry
      - run:
          name: Build Docker image
          command: |
            docker build -t realworld-app .
      - deploy:
          name: Tag and Push Docker image
          command: |
            docker tag realworld-app ${GCP_REGISTRY_PATH}/realworld-app:${CIRCLE_SHA1}
            docker tag ${GCP_REGISTRY_PATH}/realworld-app:${CIRCLE_SHA1} ${GCP_REGISTRY_PATH}/realworld-app:latest
            docker push ${GCP_REGISTRY_PATH}/realworld-app:${CIRCLE_SHA1}
            docker push ${GCP_REGISTRY_PATH}/realworld-app:latest
  deploy-helm-chart:
    docker: 
      - image: cimg/base:2021.11
    steps:
      - checkout
      - prepare-gcp
      - connect-to-gke-cluster
      - helm/install-helm-client:
          version: "v3.0.0"
      - configure-artifact-registry
      - run:
          name: Upgrade helm chart
          command: |
            helm upgrade realworld ./realworld
orbs: 
  gcp-cli: circleci/gcp-cli@2.4.0
  helm: circleci/helm@1.2.0